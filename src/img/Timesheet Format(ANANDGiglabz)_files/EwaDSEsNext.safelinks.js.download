'use strict';(window.dullscriptWebpackJsonp=window.dullscriptWebpackJsonp||[]).push([[64],{1451:function(u,E,a){a.r(E);var c=a(9);u=a(0);var b=a(4);E=a(222);var e=a(15),f=a(84);class d{constructor(M,Q,U,N,W,X){this.PolicyCookie=this.WebAffinitizedUrl=this.IsSafeLinksEnabled=null;this.PolicyCookieTTL=0;this.WasServiceDown=!1;this.AffinitizedUrl=null;this.IsSafeLinksEnabled=M;this.WebAffinitizedUrl=Q;this.PolicyCookie=U;this.PolicyCookieTTL=N;this.WasServiceDown=W;this.AffinitizedUrl=X}}Object(u.a)(d,
"SafeLinksData",null,[]);class h{constructor(M,Q){this.dBc=M;this.stopwatch=Q}}Object(u.a)(h,"SafeLinksGetUrlReputationRequestData",null,[]);var m=a(41),l=a(40);class w{constructor(M,Q,U,N){this.lb=M;this.yh=Q;this.Xug=U;w.Ah=N}Xoa(M,Q,U){try{var N=null;w.Ah&&(N=w.Ah.Ac("WebServiceCall","SafeLinksGetUrlReputation"));const W=new h(Q,N);N={};N.AffinitizedUrl=M;N.TargetUrl=Q;N.PolicyCookie=U;const X=m.c(N);this.yh.Pm(this.Xug,2,X,null,!1,2,Object(f.a)(this,this.EQi,"onGetUrlReputationSuccessCallback"),
Object(f.a)(this,this.DQi,"onGetUrlReputationFailureCallback"),W,void 0,void 0,3E3,3E3,"36");return!0}catch(W){e.ULS.sendTraceTag(588788033,378,10,W.message)}return!1}EQi(M){let Q="OnGetUrlReputationSuccessCallback: ",U=10;const N=M.data.state;try{const W=m.b(M.data.ue).reputationResults[0],X=W.navigateUrl.length,sa=N.dBc.length,da=W.navigateUrl===N.dBc;W.navigateUrl&&0<W.navigateUrl.length&&(N.dBc=W.navigateUrl);Q+=String.format("HttpStatus {0}, verdict {1}, clickedUrlLength = {2} navigateUrlLength {3}, navigateUrlSameAsClickedUrl {4}",
M.data.httpStatus,W.verdict,sa.toString(),X.toString(),da.toString());U=50}catch(W){Q+=String.format("Exception {0}",W.message)}this.u9e(N,Q,U)}DQi(M){let Q="OnGetUrlReputationFailureCallback: ";const U=M.data.state;try{Q+=String.format("HttpStatus {0}",M.data.httpStatus)}catch(N){Q+=String.format("Exception {0}",N.message)}this.u9e(U,Q,10)}u9e(M,Q,U){M.stopwatch&&(M.stopwatch.stop(),M.stopwatch=null);e.ULS.sendTraceTag(588788034,378,U,Q);l.a.lf(M.dBc,void 0,"noopener,noreferrer","SafeLinksNav")}}
w.Ah=null;Object(u.a)(w,"SafeLinksNavigationHelper",null,[]);var n;(function(M){M[M.enabledByPolicy=0]="enabledByPolicy";M[M.disabledByPolicy=1]="disabledByPolicy";M[M.disabled_GetPolicyFailure=2]="disabled_GetPolicyFailure";M[M.disabled_PendingGetPolicyRequest=3]="disabled_PendingGetPolicyRequest"})(n||(n={}));Object(u.b)("SafeLinksNavigationState",n);var y=a(97),t=a(136),r=a(818),v=a(252),B=a(240),A=a(685),z=a(27),x=a(170),D=a(189);class J{constructor(M,Q,U,N=!1,W=null,X=null){this.sEa=this.rEa=
0;this.DAb=this.hUb=!1;this.ora=null;this.lXa=!0;this.BXb=null;e.ULS.sendTraceTag(26019598,378,100,"Initializing SafeLinksManager.");this.lb=M;this.yh=Q;this.XRb=U;J.Ah=X;this.YDg=N?this.lb.Xa("SafeLinksHandlerWebServiceBase"):this.lb.Xa("WebServiceBase");this.GDg=this.lb.Xa("SafeLinksHashedUserId");this.g2j=this.lb.Xa("SafeLinksWorkloadIdHeaderValue");this.AVb=this.lb.rd("SafeLinksMaxGetPolicyBootRetries",2);this.BVb=this.lb.rd("SafeLinksMaxGetPolicyOnLinkClickRetries",1);this.LUb=this.isSafeLinksEnabledForUser();
this.KUb=this.lqi();e.ULS.sendTraceTag(26019599,378,50,"SafeLinksManager _isEnabledForUser={0}, _isEnabledForBrowser={1}",this.LUb,this.KUb);if(this.LUb&&this.KUb){Q=(M=this.y4a())?M.IsSafeLinksEnabled.toLowerCase():"";U=this.vrd();e.ULS.sendTraceTag(36231312,378,50,"Cached values for IsSafeLinksEnabled: {0}, IsPolicyCookieExpired: {1}.",Q,U);var sa=!M||"unknown"===Q||M.WasServiceDown||U,da=t.a.fs();da&&(da.set("shouldGetSafeLinksDataFromServer",sa.toString()),da.set("isSafeLinksEnabledCacheValue",
Q.toString()));this.lb.getBooleanFeatureGate("Microsoft.Office.SharedOnline.SafeLinksLicenseCheck",!1)&&W?(this.lXa=!1,W.execute(S=>{S.isFeatureEnabled("MsoUrlreputation",!0).then(oa=>{this.lXa=oa;da.set("isUserLicensedForSafeLinks",this.lXa.toString());y.Health.instance.recordKpiUsage("SafeLinksGetPolicy1",0,"jpittsdirects",da);this.lXa&&sa&&this.gdc(!0);return null})})):(y.Health.instance.recordKpiUsage("SafeLinksGetPolicy1",0,"jpittsdirects",da),sa&&this.gdc(!0))}}get appName(){return this.XRb}get NEc(){return this.YDg}get userId(){return this.GDg}get vYh(){const M=
this.NEc?this.NEc+"/":"",Q=new v.QueryStringBuilder("SafeLinksHandler.ashx");Q.Yi("app",this.appName);this.lb.qa("SafeLinksUseDebugHeader")&&Q.Yi("action","debug");this.lb.getBooleanFeatureGate("Microsoft.Office.SharedOnline.SafeLinksS2SAuthAATPOP",!1)&&Q.Yi("s2satpop","1");this.lb.getBooleanFeatureGate("Microsoft.Office.SharedOnline.SafeLinksS2SAuthAAT",!1)&&Q.Yi("s2saat","1");this.lb.getBooleanFeatureGate("Microsoft.Office.SharedOnline.SafeLinksS2SAuthUseE03App",!1)&&Q.Yi("s2se03","1");return String.format("{0}{1}&{2}",
M,Q.toString(),b.AFrameworkApplication.Ii)}get j3h(){const M=this.NEc?this.NEc+"/":"",Q=new v.QueryStringBuilder("SafeLinksHandler.ashx");Q.Yi("app",this.appName);this.lb.qa("SafeLinksUseDebugHeader")&&Q.Yi("action","debug");this.lb.getBooleanFeatureGate("Microsoft.Office.SharedOnline.SafeLinksS2SAuthAATPOP",!1)&&Q.Yi("s2satpop","1");this.lb.getBooleanFeatureGate("Microsoft.Office.SharedOnline.SafeLinksS2SAuthAAT",!1)&&Q.Yi("s2saat","1");this.lb.getBooleanFeatureGate("Microsoft.Office.SharedOnline.SafeLinksS2SAuthUseE03App",
!1)&&Q.Yi("s2se03","1");Q.Yi("slrt","GetUrlReputation");return String.format("{0}{1}&{2}",M,Q.toString(),b.AFrameworkApplication.Ii)}get MGi(){J.NRc||(J.NRc=new w(this.lb,this.yh,this.j3h,J.Ah));return J.NRc}Xoa(M){if(!M)return e.ULS.sendTraceTag(593367827,378,10,"SafeLinksManager.TryNavigate: Null/Empty targetUrl"),!1;var Q=this.Emi(M);e.ULS.sendTraceTag(594830615,378,50,"SafeLinksManager.TryNavigate: isSupportedHyperLinkType={0},_isEnabledForUser={1},_isEnabledForBrowser={2},_isUserLicensedForSafeLinks={3}",
Q,this.LUb,this.KUb,this.lXa);if(!(Q&&this.LUb&&this.KUb&&this.lXa))return!1;Q=0;const U=({state:Q}=this.$Cj()).returnValue;e.ULS.sendTraceTag(595079385,378,50,"ShouldTryUsingSafeLinksService returned NavigationState={0}",n[Q]);const N=t.a.fs();N&&N.set("SafeLinksNavigationState",n[Q]);y.Health.instance.recordKpiUsage("SafeLinksNavigations",0,"jpittsdirects",N);if(!U)return 2!==Q&&3!==Q||y.Health.instance.recordKpiFailure("SafeLinksNavigations",n[Q],!1,!0,null),!1;e.ULS.sendTraceTag(26019601,378,
50,"Using safelinks to navigate hyperlink");if(this.hDj())return this.vrd()?!1:this.MGi.Xoa(this.YLh(),M,this.T4e());if(!this.vrd())return this.Peg(M),!0;this.ora=M;e.ULS.sendTraceTag(24462627,378,50,"Refreshing the cache as policy cookie expired.");this.DAb=!1;this.gdc();return!0}Emi(M){M=M.toLowerCase();const Q=this.lb.Cw("SafeLinksUnsupportedProtocols");if(Q)for(let U=0;U<Q.length;U++)if(M.startsWith(Q[U]))return!1;return!0}gdc(M=!1){var Q=t.a.fs();Q&&Q.set("isOnBootRequest",M.toString());y.Health.instance.recordKpiUsage("SafeLinksGetPolicySuccessfulRequest",
1,"jpittsdirects",Q);y.Health.instance.recordKpiUsage("SafeLinksGetPolicyFailedRequest",0,"jpittsdirects",Q);Q=this.M4c("SafeLinksGetPolicy");this.yh.Pm(this.vYh,1,null,null,!0,2,Object(f.a)(this,this.N_h,"getSafeLinksDataFromServer_OnSuccessCallback"),Object(f.a)(this,this.M_h,"getSafeLinksDataFromServer_OnFailureCallback"),Q,void 0,void 0,void 0,void 0,"23");this.DAb=M;this.hUb=!0;M?this.rEa++:this.sEa++}N_h(M){let Q=B.a.KHi,U="";try{this.hUb=this.DAb=!1;var N=M.data.state;const ya=({stopwatch:N}=
this.sAc(N)).returnValue,ha=Object.assign(new D.a,{durationMs:ya});y.Health.instance.recordKpiSuccess("SafeLinksGetPolicySuccessfulRequest",ha);e.ULS.sendTraceTag(594830614,378,50,"GetSafeLinksDataFromServer_OnSuccessCallback: HttpStatus {0}, data length {1}, Duration {2}",M.data.httpStatus,M.data.ue.length,ya);if(M.data.httpStatus!==B.a.lP)U="Unexpected httpStatus: "+M.data.httpStatus.toString();else{N=null;try{N=m.b(M.data.ue)}catch(La){U="Exception:"+La.toString()+" deserializing response";return}if(N){var W=
N.IsSafeLinksEnabled;if(void 0===W||null===W||0>=W.length)U="Invalid isSafeLinksEnabledString";else{e.ULS.sendTraceTag(594830613,378,50,"Retrieved isSafeLinksEnabledString {0}",W);var X=J.lFd(W);if(void 0===N.WebAffinitizedUrl||null===N.WebAffinitizedUrl||0>=N.WebAffinitizedUrl.length)U="Invalid WebAffinitizedUrl";else if(void 0===N.PolicyCookie||null===N.PolicyCookie||0>=N.PolicyCookie.length)U="Invalid PolicyCookie";else if(void 0===N.PolicyCookieTTL||null===N.PolicyCookieTTL)U="Invalid PolicyCookieTTL";
else{var sa=N.WebAffinitizedUrl,da=N.PolicyCookie,S=N.AffinitizedUrl,oa=new Date;oa.setMinutes(oa.getMinutes()+(5<N.PolicyCookieTTL?N.PolicyCookieTTL-5:0));var K=oa.getTime(),ea=new d(W,sa,da,K,!1,S);this.Q1f(ea);Q=M.data.httpStatus;this.ora&&(X?(this.Peg(this.ora),this.sEa=this.rEa=0):(e.ULS.sendTraceTag(26019602,378,50,"SafeLinks is disabled by admin; Navigating without SafeLinks"),y.Health.instance.recordKpiFailure("SafeLinksNavigations","disabledByPolicy",!0,!0,null),l.a.YU(this.ora)),this.ora=
null)}}}else U="Error when serializing response into SafeLinksData. SafeLinksData is null."}}catch(ya){U="GetSafeLinksDataFromServer_OnSuccessCallback: Exception:  "+ya.toString()}finally{Q!==B.a.lP&&this.t9e(Q,U)}}M_h(M){this.hUb=!1;let Q=500,U="";try{let N=M.data.state;const W=({stopwatch:N}=this.sAc(N)).returnValue,X=Object.assign(new D.a,{durationMs:W});Q=M.data.httpStatus;y.Health.instance.recordKpiFailure("SafeLinksGetPolicyFailedRequest","HttpStatusCode_"+Q.toString(),!1,!0,X);U="Request Failed, Status="+
A.a[M.data.status]+" Duration: "+W}catch(N){U="GetSafeLinksDataFromServer_OnFailureCallback Exception: "+N.toString()}finally{this.t9e(Q,U)}}t9e(M,Q=""){try{if(e.ULS.sendTraceTag(594830612,378,10,"HandleGetPolicyRequestError: HttpStatus {0}, Error {1}",M,Q),this.rEa<this.AVb&&this.sEa<this.BVb)this.gdc(this.DAb);else{this.DAb=!1;e.ULS.sendTraceTag(24462656,378,10,"Exhausted all retries for SafeLinks GetPolicy call. OnBootRetries: {0}, OnClickRetries: {1}, HttpStatus: {2}, Error: {3}",this.rEa,this.sEa,
M,Q);Q=null;const U=t.a.fs();U&&(U.set("HttpStatus",M.toString()),Q=Object.assign(new D.a,{extendedProperties:U}));y.Health.instance.recordKpiFailure("SafeLinksGetPolicy1","GetPolicyRequestError",!1,!0,Q);const N=new d("false","","",0,!0,"");this.Q1f(N);this.ora&&(e.ULS.sendTraceTag(26019603,378,50,"Error occurred during at-click GetPolicy call, NavigationState = {0}","disabled_GetPolicyFailure"),y.Health.instance.recordKpiFailure("SafeLinksNavigations","disabled_GetPolicyFailure",!1,!0,null),l.a.YU(this.ora),
this.ora=null)}}catch(U){e.ULS.sendTraceTag(594830611,378,10,"HandleGetPolicyRequestError: Exception {0}",U.toString())}}Peg(M){const Q=this.T4e(),U=this.W3h(),N={};N.Url=M;N.SafeLinksCookie=Q;N.CorrelationId=x.a.create().toString();N.WorkloadId=this.g2j;N.UserAgentInfo=z.a.vHa+"|"+this.appName;e.ULS.sendTraceTag(23900187,378,50,"Validating hyperlink with request correlation: {0}",N.CorrelationId);l.a.Orc(l.a.CX(4),U,N)}isSafeLinksEnabledForUser(){const M=this.lb.Xa("IsSafeLinksEnabledForUser");return M?
J.lFd(M):!1}lqi(){const M=this.lb.Cw("SafeLinksDisabledBrowsers");if(z.a.Ez){if(this.lb.Zp("SafeLinksForTeamsIsEnabled")&&this.lb.qa("SafeLinksForTeamsIsEnabled"))return!0;if(Array.contains(M,"Electron"))return!1}else if(Array.contains(M,z.a.vHa))return!1;return"officecomhwa"===(this.lb.Xa(b.AFrameworkApplication.o8)||"").toLowerCase()?!1:!0}hDj(){return-1!==window.location.href.indexOf("&wd_slnh=1")||this.lb.getBooleanFeatureGate("Microsoft.Office.SharedOnline.SafeLinksUseNavigationHelperForMobile",
!1)&&z.a.v5?!0:z.a.Ez}$Cj(){let M;M=0;const Q=this.y4a(),U=Q?Q.IsSafeLinksEnabled:"";if(""!==U)return Q.WasServiceDown?(e.ULS.sendTraceTag(51663971,378,50,"Failed to retrieve policy data"),{returnValue:!1,state:2}):"false"===U.toLowerCase()?(e.ULS.sendTraceTag(51664E3,378,50,"SafeLinks disabled for the user"),{returnValue:!1,state:1}):{returnValue:J.lFd(U),state:M};if(this.hUb)return M=3,e.ULS.sendTraceTag(595079384,378,50,"Currently getting SafeLinks policy"),{returnValue:!1,state:M};if(this.rEa>=
this.AVb||this.sEa>=this.BVb)return M=2,e.ULS.sendTraceTag(51664001,378,50,"Exhausted all retries- Failure in GetPolicy for SafeLinks ({0}/{1} boot, {2}/{3} onClick)",this.rEa,this.AVb,this.sEa,this.BVb),{returnValue:!1,state:M};e.ULS.sendTraceTag(23900182,378,10,"Inconsistent SafeLinks state: SafeLinks cache data is null with no on boot request pending, and {0} retries left over. Perhaps LocalStorage is inaccessable.",this.AVb+this.BVb-(this.rEa+this.sEa));return{returnValue:!0,state:M}}T4e(){const M=
this.y4a();return M?M.PolicyCookie:""}W3h(){const M=this.y4a();return M?M.WebAffinitizedUrl:""}YLh(){const M=this.y4a();return M?M.AffinitizedUrl:""}cSh(){const M=new Date;try{const Q=this.y4a();M.setTime(Q?Q.PolicyCookieTTL:0)}catch(Q){e.ULS.sendTraceTag(24462658,378,10,"Exception occured while fetching expiration time from cache: {0}",Q)}return M}vrd(){const M=this.cSh();return!!M&&M.getTime()<Date.now()}y4a(){if(!this.BXb){const M=r.a.instance.getItem(this.userId);if(!M||""===M)return null;this.BXb=
JSON.parse(M)}return this.BXb}Q1f(M){if(void 0===M||null===M)throw Error.argumentNull("safeLinksData");if(void 0===M.IsSafeLinksEnabled||null===M.IsSafeLinksEnabled||0>=M.IsSafeLinksEnabled.length)throw Error.argumentNull("safeLinksData.IsSafeLinksEnabled");this.BXb=M;M.WasServiceDown||this.p2j(M)}p2j(M){M=JSON.stringify(M);r.a.instance.setItem(this.userId,M)}M4c(M){return void 0!==J.Ah&&null!==J.Ah?J.Ah.Ac("WebServiceCall",M):null}sAc(M){if(void 0!==M&&null!==M){const Q=M.zc;M.stop();return{returnValue:Q,
stopwatch:null}}return{returnValue:null,stopwatch:M}}static lFd(M){return"false"!==M.toLowerCase()?!0:!1}}J.Ah=null;J.NRc=null;Object(u.a)(J,"SafeLinksManager",null,[458]);const L=M=>{switch(M){case 3:return"Word";case 2:return"PowerPoint";case 1:return"Excel";default:return"Unknown"}},T=M=>{switch(M){case 1:return"Edit";case 2:return"View";case 3:return"InstantView";default:return"Unknown"}};var O=a(695);class G extends E.a{constructor(M){super();this.$=M;this.Fb()}create(){const M=Object(O.a)(this.$.da,
269,()=>new J(b.AFrameworkApplication.fa,b.AFrameworkApplication.Dd,`${L(b.AFrameworkApplication.sa.Pa.Gj)}-${T(b.AFrameworkApplication.sa.Pa.B6)}`));this.ob(M)}static ka(M){M.da.Ga(270,new G(M))}}Object(u.a)(G,"SafeLinksManagerFactory",E.a,[]);var C=a(1),H=a(229),I=a(217);Type.registerNamespace("_Ewa");Type.registerNamespace("Common.App.SafeLinks");(()=>{C.EwaSettings.ard()?Object(I.b)(H.c,{mOa:"singleton"})(()=>new J(b.AFrameworkApplication.fa,b.AFrameworkApplication.Dd,String.format("{0}-{1}",
L(b.AFrameworkApplication.sa.Pa.Gj),T(b.AFrameworkApplication.sa.Pa.B6)))):c.a.Fa(M=>{G.ka(M)})})()}}]);

//# sourceMappingURL=https://artifacts.dev.azure.com/office/_apis/symbol/symsrv/EwaDSEsNext.safelinks.js.map/63defd11a4e71a451e75d1b649405911/EwaDSEsNext.safelinks.js.map